---
- name: Bootstrap k3s on Fedora Linux VMs
  hosts: localhost
  connection: local
  become: yes

  vars:
    k3s_version: v1.33.4+k3s1
    k3s_install_url: https://get.k3s.io

  tasks:
    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Ensure system is up to date
      dnf:
        name: "*"
        state: latest
        update_cache: yes

    - name: Install required dependencies
      dnf:
        name:
          - curl
          - iptables
          - socat
          - conntrack
          - selinux-policy-base
        state: present

    - name: Download and install k3s
      shell: |
        curl -sfL {{ k3s_install_url }} | INSTALL_K3S_VERSION={{ k3s_version }} sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Enable and start k3s service
      systemd:
        name: k3s
        enabled: yes
        state: started
      when: ansible_facts.services['k3s.service'] is defined
      failed_when: false
      check_mode: no

    - name: Wait for k3s service to be active
      systemd:
        name: k3s
        state: started
        enabled: yes
        daemon_reload: yes
      when: ansible_facts.services['k3s.service'] is defined
      failed_when: false
      check_mode: no

    - name: Display k3s node token
      command: cat /var/lib/rancher/k3s/server/node-token
      register: node_token
      changed_when: false
      failed_when: false

    - name: Show node token
      debug:
        msg: "Node token: {{ node_token.stdout }}"